# REST API Plan

This document outlines the REST API for the AI Flashcards application, designed based on the provided database schema and product requirements.

## 1. Resources

- **Generations**: Represents a job to generate flashcards from a source text using an AI model.
  - Corresponds to the `generations` database table.
- **Flashcards**: Represents a single flashcard, either manually created or generated by AI.
  - Corresponds to the `flashcards` database table.

## 2. Endpoints

### Generations Resource

#### `POST /api/generations`

- **Description**: Creates a new AI generation task. This involves calling an external AI service and creating a batch of flashcards with a `waiting_for_approval` status.
- **Request Body**:
  ```json
  {
    "source_text": "The text to generate flashcards from...",
    "count": 15
  }
  ```
- **Response Body (Success)**:
  ```json
  {
    "generation": {
      "id": 1,
      "user_id": "user-uuid-123",
      "model": "gpt-4o",
      "generated_count": 15,
      "source_text_length": 450,
      "created_at": "2023-10-27T10:00:00Z"
    },
    "flashcards": [
      {
        "id": 101,
        "generation_id": 1,
        "front": "Generated Question 1",
        "back": "Generated Answer 1",
        "status": "waiting_for_approval",
        "source": "AI",
        "is_edited": false
      }
    ]
  }
  ```
- **Success Code**: `201 Created`
- **Error Codes**:
  - `400 Bad Request`: Invalid input (e.g., `source_text` too long, `count` out of range).
  - `401 Unauthorized`: User is not authenticated.
  - `500 Internal Server Error`: AI service failed or database error.

---

### Flashcards Resource

#### `GET /api/flashcards`

- **Description**: Retrieves a list of flashcards for the authenticated user. Supports filtering and pagination.
- **Query Parameters**:
  - `status` (optional, string): Filter by status. Can be `approved` or `waiting_for_approval`.
  - `source` (optional, string): Filter by source. Can be `AI` or `MANUAL`.
  - `generation_id` (optional, number): Filter by a specific generation job.
  - `limit` (optional, number, default: 20): Number of items to return for pagination.
  - `offset` (optional, number, default: 0): Starting offset for pagination.
- **Response Body (Success)**:
  ```json
  [
    {
      "id": 1,
      "user_id": "user-uuid-123",
      "generation_id": null,
      "front": "What is REST?",
      "back": "Representational State Transfer.",
      "status": "approved",
      "source": "MANUAL",
      "is_edited": false,
      "created_at": "2023-10-27T10:00:00Z",
      "updated_at": "2023-10-27T10:00:00Z"
    }
  ]
  ```
- **Success Code**: `200 OK`
- **Error Codes**:
  - `401 Unauthorized`: User is not authenticated.

#### `POST /api/flashcards`

- **Description**: Creates a new flashcard manually. Manually created flashcards are automatically `approved`.
- **Request Body**:
  ```json
  {
    "front": "Manual Question",
    "back": "Manual Answer"
  }
  ```
- **Response Body (Success)**:
  ```json
  {
    "id": 2,
    "user_id": "user-uuid-123",
    "generation_id": null,
    "front": "Manual Question",
    "back": "Manual Answer",
    "status": "approved",
    "source": "MANUAL",
    "is_edited": false,
    "created_at": "2023-10-27T11:00:00Z",
    "updated_at": "2023-10-27T11:00:00Z"
  }
  ```
- **Success Code**: `201 Created`
- **Error Codes**:
  - `400 Bad Request`: Missing `front` or `back` fields.
  - `401 Unauthorized`: User is not authenticated.

#### `GET /api/flashcards/{id}`

- **Description**: Retrieves a single flashcard by its ID.
- **Response Body (Success)**:
  ```json
  {
    "id": 1,
    "user_id": "user-uuid-123",
    "generation_id": null,
    "front": "What is REST?",
    "back": "Representational State Transfer.",
    "status": "approved",
    "source": "MANUAL",
    "is_edited": false,
    "created_at": "2023-10-27T10:00:00Z",
    "updated_at": "2023-10-27T10:00:00Z"
  }
  ```
- **Success Code**: `200 OK`
- **Error Codes**:
  - `401 Unauthorized`: User is not authenticated.
  - `404 Not Found`: Flashcard with the given ID does not exist or does not belong to the user.

#### `PATCH /api/flashcards/{id}`

- **Description**: Updates a flashcard. Can be used to change content (`front`/`back`) or `status`.
- **Request Body**:
  ```json
  {
    "front": "Updated Question",
    "back": "Updated Answer",
    "status": "approved"
  }
  ```
- **Response Body (Success)**: The updated flashcard object.
  ```json
  {
    "id": 1,
    "user_id": "user-uuid-123",
    "generation_id": 1,
    "front": "Updated Question",
    "back": "Updated Answer",
    "status": "approved",
    "source": "AI",
    "is_edited": true,
    "created_at": "2023-10-27T10:00:00Z",
    "updated_at": "2023-10-27T12:00:00Z"
  }
  ```
- **Success Code**: `200 OK`
- **Error Codes**:
  - `400 Bad Request`: Invalid field in request body.
  - `401 Unauthorized`: User is not authenticated.
  - `404 Not Found`: Flashcard not found.

#### `DELETE /api/flashcards/{id}`

- **Description**: Deletes a flashcard. Can be used to reject an AI-generated flashcard or delete any existing flashcard.
- **Response Body (Success)**: Empty body.
- **Success Code**: `204 No Content`
- **Error Codes**:
  - `401 Unauthorized`: User is not authenticated.
  - `404 Not Found`: Flashcard not found.

## 3. Authentication and Authorization

- **Mechanism**: Authentication will be handled using JSON Web Tokens (JWT) provided by Supabase Auth.
- **Implementation**:
  - The client will include the JWT in the `Authorization` header of every request (`Bearer <token>`).
  - The Next.js API backend (Route Handlers) will use the Supabase server-side client to verify the token and get the authenticated user's ID.
  - All database queries will be executed through the Supabase client, which will pass the user's authentication context to PostgreSQL.
  - **Authorization** is enforced at the database level using Row-Level Security (RLS) policies, ensuring users can only access their own `generations` and `flashcards` data.

## 4. Validation and Business Logic

### Validation

- **`POST /api/generations`**:
  - `source_text`: required, string, max 10,000 characters.
  - `count`: required, integer, between 10 and 30.
- **`POST /api/flashcards`**:
  - `front`: required, string, max 1000 characters.
  - `back`: required, string, max 1000 characters.
- **`PATCH /api/flashcards/{id}`**:
  - `front` / `back`: optional, string, max 1000 characters.
  - `status`: optional, string, must be one of `waiting_for_approval` or `approved`.

### Business Logic Implementation

- **Auto-approval on Edit**: When a `PATCH /api/flashcards/{id}` request is received for a flashcard with `status: 'waiting_for_approval'`, and the request contains `front` or `back` content, the API will automatically update the `status` to `'approved'`.
- **Edited Flag**: When a `PATCH` request modifies the `front` or `back` of a flashcard with `source: 'AI'`, the `is_edited` flag will be set to `true`.
- **Default Statuses**:
  - Manually created flashcards (`POST /api/flashcards`) will have `status` set to `'approved'` and `source` set to `'MANUAL'` by default.
  - AI-generated flashcards (`POST /api/generations`) will have `status` set to `'waiting_for_approval'` and `source` set to `'AI'`.
